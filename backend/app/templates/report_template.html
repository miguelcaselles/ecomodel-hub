<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cost-Effectiveness Analysis Report - {{ scenario_name }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm 1.5cm;
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #64748B;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #0F172A;
            font-size: 11pt;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3B82F6;
            padding-bottom: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #0F172A 0%, #3B82F6 100%);
            border-radius: 12px;
            color: white;
            font-size: 32px;
            font-weight: 700;
            line-height: 60px;
            margin: 0 auto 15px;
        }

        h1 {
            font-size: 24pt;
            color: #0F172A;
            margin: 10px 0 5px 0;
            font-weight: 700;
        }

        .subtitle {
            font-size: 12pt;
            color: #64748B;
            margin: 0;
        }

        .metadata {
            background: #F8FAFC;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 10pt;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
        }

        .metadata-label {
            font-weight: 600;
            color: #475569;
        }

        .metadata-value {
            color: #0F172A;
        }

        h2 {
            font-size: 16pt;
            color: #0F172A;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #E2E8F0;
            padding-bottom: 8px;
            font-weight: 600;
        }

        h3 {
            font-size: 13pt;
            color: #334155;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .kpi-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .kpi-label {
            font-size: 10pt;
            color: #64748B;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 20pt;
            color: #0F172A;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-unit {
            font-size: 9pt;
            color: #94A3B8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }

        thead th {
            background: #F1F5F9;
            color: #334155;
            font-weight: 600;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #CBD5E1;
        }

        tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #E2E8F0;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:nth-child(even) {
            background: #F8FAFC;
        }

        .metric-name {
            font-weight: 600;
            color: #475569;
        }

        .conclusion-box {
            background: #DBEAFE;
            border-left: 4px solid #3B82F6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .conclusion-box.cost-effective {
            background: #D1FAE5;
            border-left-color: #059669;
        }

        .conclusion-box.not-cost-effective {
            background: #FEE2E2;
            border-left-color: #DC2626;
        }

        .conclusion-title {
            font-weight: 700;
            font-size: 12pt;
            margin-bottom: 8px;
        }

        .conclusion-text {
            font-size: 10pt;
            line-height: 1.6;
        }

        .chart-container {
            margin: 20px 0;
            text-align: center;
            page-break-inside: avoid;
        }

        .chart-title {
            font-size: 11pt;
            font-weight: 600;
            color: #334155;
            margin-bottom: 10px;
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
            font-size: 10pt;
        }

        .parameter-item {
            background: #F8FAFC;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .parameter-label {
            font-weight: 500;
            color: #475569;
        }

        .parameter-value {
            font-weight: 600;
            color: #0F172A;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #E2E8F0;
            font-size: 9pt;
            color: #64748B;
            text-align: center;
        }

        .page-break {
            page-break-after: always;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 9pt;
            font-weight: 600;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge-info {
            background: #DBEAFE;
            color: #1E40AF;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">E</div>
        <h1>Cost-Effectiveness Analysis Report</h1>
        <p class="subtitle">{{ scenario_name }}</p>
    </div>

    <!-- Metadata -->
    <div class="metadata">
        <div class="metadata-grid">
            <div class="metadata-item">
                <span class="metadata-label">Report Date:</span>
                <span class="metadata-value">{{ report_date }}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Generated By:</span>
                <span class="metadata-value">{{ user_email }}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Organization:</span>
                <span class="metadata-value">{{ organization }}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Model Type:</span>
                <span class="metadata-value">Markov 3-State</span>
            </div>
        </div>
    </div>

    <!-- Executive Summary -->
    <h2>Executive Summary</h2>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">ICER</div>
            <div class="kpi-value">€{{ "{:,.0f}".format(icer) }}</div>
            <div class="kpi-unit">per QALY gained</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">ΔQALYs</div>
            <div class="kpi-value">{{ "{:.3f}".format(delta_qalys) }}</div>
            <div class="kpi-unit">Quality-adjusted life years</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">ΔCosts</div>
            <div class="kpi-value">€{{ "{:,.0f}".format(delta_costs) }}</div>
            <div class="kpi-unit">Incremental costs</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Conclusion</div>
            <div class="kpi-value">
                {% if is_cost_effective %}
                <span class="badge badge-success">Cost-Effective</span>
                {% else %}
                <span class="badge badge-danger">Not Cost-Effective</span>
                {% endif %}
            </div>
            <div class="kpi-unit">at €{{ "{:,.0f}".format(wtp_threshold) }}/QALY</div>
        </div>
    </div>

    <div class="conclusion-box {% if is_cost_effective %}cost-effective{% else %}not-cost-effective{% endif %}">
        <div class="conclusion-title">Clinical and Economic Interpretation</div>
        <div class="conclusion-text">
            {% if is_cost_effective %}
            The new treatment (Drug A) is considered <strong>cost-effective</strong> compared to the standard treatment (Drug B)
            at the willingness-to-pay threshold of €{{ "{:,.0f}".format(wtp_threshold) }} per QALY gained.
            The incremental cost-effectiveness ratio (ICER) of €{{ "{:,.0f}".format(icer) }}/QALY is below the established threshold,
            indicating favorable value for money. The treatment provides an additional {{ "{:.3f}".format(delta_qalys) }} QALYs
            at an incremental cost of €{{ "{:,.0f}".format(delta_costs) }}.
            {% else %}
            The new treatment (Drug A) is <strong>not cost-effective</strong> compared to the standard treatment (Drug B)
            at the willingness-to-pay threshold of €{{ "{:,.0f}".format(wtp_threshold) }} per QALY gained.
            The incremental cost-effectiveness ratio (ICER) of €{{ "{:,.0f}".format(icer) }}/QALY exceeds the established threshold.
            While the treatment provides an additional {{ "{:.3f}".format(delta_qalys) }} QALYs, the incremental cost of
            €{{ "{:,.0f}".format(delta_costs) }} is not justified at the current WTP threshold.
            {% endif %}
        </div>
    </div>

    <!-- Model Parameters -->
    <h2>Model Parameters</h2>

    <h3>Cost Parameters</h3>
    <div class="parameters-grid">
        <div class="parameter-item">
            <span class="parameter-label">Drug A Cost (€/cycle):</span>
            <span class="parameter-value">€{{ "{:,.0f}".format(parameters.cost_drug_a) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Drug B Cost (€/cycle):</span>
            <span class="parameter-value">€{{ "{:,.0f}".format(parameters.cost_drug_b) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Healthcare Cost - Stable (€):</span>
            <span class="parameter-value">€{{ "{:,.0f}".format(parameters.cost_state_s) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Healthcare Cost - Progression (€):</span>
            <span class="parameter-value">€{{ "{:,.0f}".format(parameters.cost_state_p) }}</span>
        </div>
    </div>

    <h3>Clinical Parameters</h3>
    <div class="parameters-grid">
        <div class="parameter-item">
            <span class="parameter-label">Progression Risk - Drug A:</span>
            <span class="parameter-value">{{ "{:.1%}".format(parameters.prob_s_to_p_a) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Progression Risk - Drug B:</span>
            <span class="parameter-value">{{ "{:.1%}".format(parameters.prob_s_to_p_b) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Utility - Stable:</span>
            <span class="parameter-value">{{ "{:.2f}".format(parameters.utility_stable) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Utility - Progression:</span>
            <span class="parameter-value">{{ "{:.2f}".format(parameters.utility_progression) }}</span>
        </div>
    </div>

    <h3>Model Settings</h3>
    <div class="parameters-grid">
        <div class="parameter-item">
            <span class="parameter-label">Time Horizon:</span>
            <span class="parameter-value">{{ parameters.time_horizon }} years</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Discount Rate:</span>
            <span class="parameter-value">{{ "{:.1%}".format(parameters.discount_rate) }}</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">WTP Threshold:</span>
            <span class="parameter-value">€{{ "{:,.0f}".format(parameters.get('wtp_threshold', 30000)) }}/QALY</span>
        </div>
        <div class="parameter-item">
            <span class="parameter-label">Cycle Length:</span>
            <span class="parameter-value">1 year</span>
        </div>
    </div>

    <div class="page-break"></div>

    <!-- Detailed Results -->
    <h2>Detailed Results</h2>

    <h3>Comparative Effectiveness and Costs</h3>
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Drug A (New)</th>
                <th>Drug B (Standard)</th>
                <th>Difference (Δ)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="metric-name">Total Costs (€)</td>
                <td>€{{ "{:,.0f}".format(results_drug_a.total_cost) }}</td>
                <td>€{{ "{:,.0f}".format(results_drug_b.total_cost) }}</td>
                <td>€{{ "{:,.0f}".format(delta_costs) }}</td>
            </tr>
            <tr>
                <td class="metric-name">Total QALYs</td>
                <td>{{ "{:.3f}".format(results_drug_a.total_qalys) }}</td>
                <td>{{ "{:.3f}".format(results_drug_b.total_qalys) }}</td>
                <td>{{ "{:.3f}".format(delta_qalys) }}</td>
            </tr>
            <tr>
                <td class="metric-name">Life Years</td>
                <td>{{ "{:.2f}".format(results_drug_a.life_years) }}</td>
                <td>{{ "{:.2f}".format(results_drug_b.life_years) }}</td>
                <td>{{ "{:.2f}".format(results_drug_a.life_years - results_drug_b.life_years) }}</td>
            </tr>
            <tr>
                <td class="metric-name">ICER (€/QALY)</td>
                <td colspan="3" style="text-align: center; font-weight: 700; font-size: 12pt;">
                    €{{ "{:,.0f}".format(icer) }}
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Charts would go here if images were provided -->
    {% if chart_ce_plane %}
    <div class="chart-container">
        <div class="chart-title">Cost-Effectiveness Plane</div>
        <img src="{{ chart_ce_plane }}" class="chart-image" alt="CE Plane">
    </div>
    {% endif %}

    {% if has_psa %}
    <div class="page-break"></div>
    <h2>Probabilistic Sensitivity Analysis (PSA)</h2>

    <p>Monte Carlo simulation with {{ psa_iterations }} iterations to assess parameter uncertainty.</p>

    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Mean</th>
                <th>P2.5 (95% CI)</th>
                <th>P50 (Median)</th>
                <th>P97.5 (95% CI)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="metric-name">ICER (€/QALY)</td>
                <td>€{{ "{:,.0f}".format(psa_results.mean_icer) }}</td>
                <td>€{{ "{:,.0f}".format(psa_results.p2_5) }}</td>
                <td>€{{ "{:,.0f}".format(psa_results.p50) }}</td>
                <td>€{{ "{:,.0f}".format(psa_results.p97_5) }}</td>
            </tr>
            <tr>
                <td class="metric-name">% Cost-Effective at €{{ "{:,.0f}".format(wtp_threshold) }} WTP</td>
                <td colspan="4" style="text-align: center; font-weight: 700;">
                    {{ "{:.1%}".format(psa_results.prob_cost_effective) }}
                </td>
            </tr>
        </tbody>
    </table>

    {% if chart_ceac %}
    <div class="chart-container">
        <div class="chart-title">Cost-Effectiveness Acceptability Curve (CEAC)</div>
        <img src="{{ chart_ceac }}" class="chart-image" alt="CEAC">
    </div>
    {% endif %}

    {% if chart_psa_scatter %}
    <div class="chart-container">
        <div class="chart-title">PSA Scatter Plot ({{ psa_iterations }} iterations)</div>
        <img src="{{ chart_psa_scatter }}" class="chart-image" alt="PSA Scatter">
    </div>
    {% endif %}
    {% endif %}

    <!-- Footer -->
    <div class="footer">
        <p>
            <strong>Generated by EcoModel Hub</strong> - Professional HEOR Platform<br>
            This report was automatically generated on {{ report_date }} by {{ user_email }}<br>
            <em>Confidential - For internal use only</em>
        </p>
        <p style="margin-top: 10px; font-size: 8pt;">
            Disclaimer: This analysis is based on the parameters and assumptions provided.
            Results should be interpreted in the context of clinical evidence and local healthcare settings.
            This report does not constitute medical advice or reimbursement recommendations.
        </p>
    </div>
</body>
</html>
